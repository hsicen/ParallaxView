package com.hsicen.parallaxviewimport android.annotation.SuppressLintimport android.content.Contextimport android.content.res.Resourcesimport android.graphics.Rectimport android.os.Buildimport android.util.AttributeSetimport android.util.TypedValueimport android.view.Viewimport android.view.ViewGroupimport android.view.ViewGroup.LayoutParams.MATCH_PARENTimport android.view.ViewGroup.LayoutParams.WRAP_CONTENTimport android.widget.LinearLayoutimport androidx.recyclerview.widget.LinearLayoutManagerimport androidx.recyclerview.widget.RecyclerViewclass ParallaxView @JvmOverloads constructor(  context: Context,  attrs: AttributeSet? = null,  defStyleAttr: Int = 0) : LinearLayout(context, attrs, defStyleAttr) {  companion object {    private const val RV_COUNT = 2  }  private lateinit var mConfig: ParallaxViewConfig  private val mData = ArrayList<ParallaxData>()  private val mScrollListeners = arrayOfNulls<RecyclerView.OnScrollListener>(RV_COUNT)  private val mDecoration by lazy {    object : RecyclerView.ItemDecoration() {      val margin = 5.dp2px      override fun getItemOffsets(        outRect: Rect,        view: View,        parent: RecyclerView,        state: RecyclerView.State      ) {        super.getItemOffsets(outRect, view, parent, state)        val manager = parent.layoutManager ?: return        val rlp = (view.layoutParams as? RecyclerView.LayoutParams) ?: return        val position = rlp.viewLayoutPosition        val count = manager.itemCount        if (position == RecyclerView.NO_POSITION || 0 == count) return        outRect[margin, margin, margin] = margin      }    }  }  private val mAdapter1 by lazy {    object : RecyclerView.Adapter<ParallaxViewHolder>() {      override fun getItemCount(): Int = mData.size * 2000      override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): ParallaxViewHolder {        return mConfig.parallaxAdapter.onCreateViewHolder(parent, viewType)      }      override fun onBindViewHolder(holder: ParallaxViewHolder, position: Int) {        val pos = position * 2        val item = mData[pos % mData.size]        mConfig.parallaxAdapter.onBindViewHolder(holder, pos, item)        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {          holder.root.tooltipText = "$pos"        }      }      override fun onViewAttachedToWindow(holder: ParallaxViewHolder) {        super.onViewAttachedToWindow(holder)        if (holder.layoutPosition == RecyclerView.NO_POSITION) return        val pos = (holder.layoutPosition * 2) % mData.size        mData.getOrNull(pos)?.let { item ->          mConfig.parallaxAdapter.onAttachedToWindow(holder, pos, item)        }      }      override fun onViewDetachedFromWindow(holder: ParallaxViewHolder) {        super.onViewDetachedFromWindow(holder)        if (holder.layoutPosition == RecyclerView.NO_POSITION) return        val pos = (holder.layoutPosition * 2) % mData.size        mData.getOrNull(pos)?.let { item ->          mConfig.parallaxAdapter.onDetachedFromWindow(holder, pos, item)        }      }    }  }  private val mAdapter2 by lazy {    object : RecyclerView.Adapter<ParallaxViewHolder>() {      override fun getItemCount(): Int = mData.size * 2000      override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): ParallaxViewHolder {        return mConfig.parallaxAdapter.onCreateViewHolder(parent, viewType)      }      override fun onBindViewHolder(holder: ParallaxViewHolder, position: Int) {        val pos = position * 2 + 1        val item = mData[pos % mData.size]        mConfig.parallaxAdapter.onBindViewHolder(holder, pos, item)        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {          holder.root.tooltipText = "$pos"        }      }      override fun onViewAttachedToWindow(holder: ParallaxViewHolder) {        super.onViewAttachedToWindow(holder)        if (holder.layoutPosition == RecyclerView.NO_POSITION) return        val pos = (holder.layoutPosition * 2 + 1) % mData.size        mData.getOrNull(pos)?.let { item ->          mConfig.parallaxAdapter.onAttachedToWindow(holder, pos, item)        }      }      override fun onViewDetachedFromWindow(holder: ParallaxViewHolder) {        super.onViewDetachedFromWindow(holder)        if (holder.layoutPosition == RecyclerView.NO_POSITION) return        val pos = (holder.layoutPosition * 2 + 1) % mData.size        mData.getOrNull(pos)?.let { item ->          mConfig.parallaxAdapter.onDetachedFromWindow(holder, pos, item)        }      }    }  }  private val mRv1 by lazy {    RecyclerView(context).apply {      adapter = mAdapter1      setHasFixedSize(true)      itemAnimator = null      isNestedScrollingEnabled = false      layoutParams = ViewGroup.LayoutParams(MATCH_PARENT, WRAP_CONTENT)      layoutManager = LinearLayoutManager(context, RecyclerView.HORIZONTAL, false)      addItemDecoration(mDecoration)      mScrollListeners[0]?.let { addOnScrollListener(it) }    }  }  private val mRv2 by lazy {    RecyclerView(context).apply {      adapter = mAdapter2      setHasFixedSize(true)      itemAnimator = null      isNestedScrollingEnabled = false      layoutParams = ViewGroup.LayoutParams(MATCH_PARENT, WRAP_CONTENT)      layoutManager = LinearLayoutManager(context, RecyclerView.HORIZONTAL, false)      addItemDecoration(mDecoration)      mScrollListeners[1]?.let { addOnScrollListener(it) }    }  }  init {    orientation = VERTICAL    isMotionEventSplittingEnabled = false    mScrollListeners[0] = object : RecyclerView.OnScrollListener() {      override fun onScrolled(recyclerView: RecyclerView, dx: Int, dy: Int) {        super.onScrolled(recyclerView, dx, dy)        mScrollListeners[1]?.let { mRv2.removeOnScrollListener(it) }        mRv2.scrollBy(dx, dy)        mScrollListeners[1]?.let { mRv2.addOnScrollListener(it) }      }    }    mScrollListeners[1] = object : RecyclerView.OnScrollListener() {      override fun onScrolled(recyclerView: RecyclerView, dx: Int, dy: Int) {        super.onScrolled(recyclerView, dx, dy)        mScrollListeners[0]?.let { mRv1.removeOnScrollListener(it) }        mRv1.scrollBy(dx, dy)        mScrollListeners[0]?.let { mRv1.addOnScrollListener(it) }      }    }    addView(mRv1)    addView(mRv2)  }  @SuppressLint("NotifyDataSetChanged")  fun updateData(list: List<ParallaxData>) {    fun setNewInstance(list: List<ParallaxData>) {      if (::mConfig.isInitialized.not()) return      if (list == mData) return      mData.clear()      mData.addAll(list)      mAdapter1.notifyDataSetChanged()      mAdapter2.notifyDataSetChanged()    }    setNewInstance(list)    scrollToLast()  }  fun addConfig(config: ParallaxViewConfig): ParallaxView {    mConfig = config    return this  }  private fun scrollToLast() {    post {      val offsetPos = mData.size * 1000      (mRv1.layoutManager as? LinearLayoutManager)        ?.scrollToPositionWithOffset(offsetPos, mConfig.offsetFirst)      (mRv2.layoutManager as? LinearLayoutManager)        ?.scrollToPositionWithOffset(offsetPos, mConfig.offsetSecond)    }  }  data class ParallaxData(val img: String)  class ParallaxViewHolder(val root: View) : RecyclerView.ViewHolder(root)  class ParallaxViewConfig(    var offsetFirst: Int = 0,    var offsetSecond: Int = 0,    var parallaxAdapter: ParallaxViewAdapter  )  interface ParallaxViewAdapter {    fun onCreateViewHolder(parent: ViewGroup, viewType: Int): ParallaxViewHolder    fun onBindViewHolder(holder: ParallaxViewHolder, position: Int, data: ParallaxData)    fun onAttachedToWindow(holder: ParallaxViewHolder, position: Int, data: ParallaxData) {}    fun onDetachedFromWindow(holder: ParallaxViewHolder, position: Int, data: ParallaxData) {}  }  /******====== Tools ======******/  inline val Int.dp2px: Int    get() = TypedValue.applyDimension(      TypedValue.COMPLEX_UNIT_DIP, this * 1.0f, Resources.getSystem().displayMetrics    ).toInt()  private inline val Float.dp2px: Float    get() = TypedValue.applyDimension(      TypedValue.COMPLEX_UNIT_DIP, this, Resources.getSystem().displayMetrics    )}